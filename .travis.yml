dist: xenial
language: python
python: "3.7"

cache:
    pip: true
    directories:
      - $HOME/.cache/pypoetry
      - $HOME/.ccache

jobs:
    include:
      - stage: lint
        script: poetry run invoke lint
      - stage: test
        before_script:
          # Install pyenv
          - git clone https://github.com/pyenv/pyenv.git ~/.pyenv
          - git clone https://github.com/pyenv/pyenv-ccache.git ~/.pyenv/plugins/pyenv-ccache
          - export PYENV_ROOT="$HOME/.pyenv"
          - export PATH="$PYENV_ROOT/bin:$PATH"
          - eval "$(pyenv init -)"
          - pyenv --version
          # Install Python versions
          - pyenv install -s 3.4.9
          - pyenv install -s 3.5.7
          - pyenv install -s 3.6.8
          - pyenv install -s 3.7.3
          - pyenv install -s 3.8-dev
          - pyenv local 3.4.9 3.5.7 3.6.8 3.7.3 3.8-dev
        script: poetry run invoke test --all
        after_success: poetry run coverage report

before_install: pip install poetry
install: poetry install
